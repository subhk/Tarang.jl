<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial: 2D Rayleigh-Bénard Convection · Tarang.jl</title><meta name="title" content="Tutorial: 2D Rayleigh-Bénard Convection · Tarang.jl"/><meta property="og:title" content="Tutorial: 2D Rayleigh-Bénard Convection · Tarang.jl"/><meta property="twitter:title" content="Tutorial: 2D Rayleigh-Bénard Convection · Tarang.jl"/><meta name="description" content="Documentation for Tarang.jl."/><meta property="og:description" content="Documentation for Tarang.jl."/><meta property="twitter:description" content="Documentation for Tarang.jl."/><meta property="og:url" content="https://subhk.github.io/Tarang.jl/tutorials/ivp_2d_rbc/"/><meta property="twitter:url" content="https://subhk.github.io/Tarang.jl/tutorials/ivp_2d_rbc/"/><link rel="canonical" href="https://subhk.github.io/Tarang.jl/tutorials/ivp_2d_rbc/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/custom.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Tarang.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Tarang.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Installing Tarang</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../getting_started/installation/">Installation</a></li><li><a class="tocitem" href="../../getting_started/first_steps/">First Steps with Tarang.jl</a></li><li><a class="tocitem" href="../../getting_started/running_with_mpi/">Running with MPI</a></li><li><a class="tocitem" href="../../pages/configuration/">Configuration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials &amp; Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox" checked/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Tutorial Notebooks</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../overview/">Tutorials Overview</a></li><li class="is-active"><a class="tocitem" href>Tutorial: 2D Rayleigh-Bénard Convection</a><ul class="internal"><li><a class="tocitem" href="#Physical-Problem"><span>Physical Problem</span></a></li><li><a class="tocitem" href="#Domain-and-Discretization"><span>Domain and Discretization</span></a></li><li><a class="tocitem" href="#Complete-Implementation"><span>Complete Implementation</span></a></li><li><a class="tocitem" href="#Running-the-Simulation"><span>Running the Simulation</span></a></li><li><a class="tocitem" href="#Physical-Interpretation"><span>Physical Interpretation</span></a></li><li><a class="tocitem" href="#Visualization"><span>Visualization</span></a></li><li><a class="tocitem" href="#Parameter-Studies"><span>Parameter Studies</span></a></li><li><a class="tocitem" href="#Performance-Optimization"><span>Performance Optimization</span></a></li><li><a class="tocitem" href="#Troubleshooting"><span>Troubleshooting</span></a></li><li><a class="tocitem" href="#Complete-Script"><span>Complete Script</span></a></li><li><a class="tocitem" href="#Next-Steps"><span>Next Steps</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../ivp_3d_turbulence/">Tutorial: 3D Turbulence Simulation</a></li><li><a class="tocitem" href="../boundary_conditions/">Tutorial: Boundary Conditions</a></li><li><a class="tocitem" href="../analysis_and_output/">Tutorial: Analysis and Output</a></li><li><a class="tocitem" href="../eigenvalue_problems/">Tutorial: Eigenvalue Problems</a></li><li><a class="tocitem" href="../surface_dynamics/">Surface and Boundary Dynamics</a></li><li><a class="tocitem" href="../rotating_shallow_water/">Rotating Shallow Water with Lagrangian Averaging</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Example Scripts</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/gallery/">Example Gallery</a></li><li><a class="tocitem" href="../../examples/fluid_dynamics/">Fluid Dynamics Examples</a></li><li><a class="tocitem" href="../../examples/heat_transfer/">Heat Transfer Examples</a></li><li><a class="tocitem" href="../../examples/eigenvalue_analysis/">Eigenvalue Analysis Examples</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Jupyter Notebooks</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../notebooks/rayleigh_benard/">Notebook: Rayleigh-Bénard Convection</a></li><li><a class="tocitem" href="../../notebooks/channel_flow/">Notebook: Channel Flow</a></li><li><a class="tocitem" href="../../notebooks/taylor_green/">Notebook: Taylor-Green Vortex</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">User Guide</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Core Concepts</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/coordinates/">Coordinates</a></li><li><a class="tocitem" href="../../pages/bases/">Spectral Bases</a></li><li><a class="tocitem" href="../../pages/domains/">Domains</a></li><li><a class="tocitem" href="../../pages/fields/">Fields</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Problem Setup</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/operators/">Operators</a></li><li><a class="tocitem" href="../../pages/problems/">Problems</a></li><li><a class="tocitem" href="../../pages/solvers/">Solvers</a></li><li><a class="tocitem" href="../../pages/timesteppers/">Time Steppers</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Physics &amp; Modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/stochastic_forcing/">Stochastic Forcing</a></li><li><a class="tocitem" href="../../pages/temporal_filters/">Temporal Filters for Lagrangian Averaging</a></li><li><a class="tocitem" href="../../pages/les_models/">Large Eddy Simulation (LES) Models</a></li><li><a class="tocitem" href="../../pages/gql_approximation/">Generalized Quasi-Linear (GQL) Approximation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label">Performance &amp; Parallelism</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/gpu_computing/">GPU Computing</a></li><li><a class="tocitem" href="../../pages/parallelism/">Parallelism</a></li><li><a class="tocitem" href="../../pages/optimization/">Performance Optimization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Analysis &amp; Output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/analysis/">Analysis</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-6" type="checkbox"/><label class="tocitem" for="menuitem-4-6"><span class="docs-label">Advanced Topics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/tau_method/">The Tau Method for Boundary Conditions</a></li><li><a class="tocitem" href="../../pages/custom_operators/">Custom Operators</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">API Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-5-1" type="checkbox"/><label class="tocitem" for="menuitem-5-1"><span class="docs-label">Core</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/coordinates/">Coordinates API</a></li><li><a class="tocitem" href="../../api/bases/">Bases API</a></li><li><a class="tocitem" href="../../api/domains/">Domains API</a></li><li><a class="tocitem" href="../../api/fields/">Fields API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Operators &amp; Problems</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/operators/">Operators API</a></li><li><a class="tocitem" href="../../api/problems/">Problems API</a></li><li><a class="tocitem" href="../../api/solvers/">Solvers API</a></li><li><a class="tocitem" href="../../api/timesteppers/">Timesteppers API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">GPU &amp; Performance</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/gpu/">GPU API Reference</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-4" type="checkbox"/><label class="tocitem" for="menuitem-5-4"><span class="docs-label">Extras</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/stochastic_forcing/">Stochastic Forcing API</a></li><li><a class="tocitem" href="../../api/les_models/">LES Models API</a></li><li><a class="tocitem" href="../../api/analysis/">Analysis API</a></li><li><a class="tocitem" href="../../api/io/">I/O API</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Development</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../pages/contributing/">Contributing</a></li><li><a class="tocitem" href="../../pages/architecture/">Architecture</a></li><li><a class="tocitem" href="../../pages/testing/">Testing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials &amp; Examples</a></li><li><a class="is-disabled">Tutorial Notebooks</a></li><li class="is-active"><a href>Tutorial: 2D Rayleigh-Bénard Convection</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial: 2D Rayleigh-Bénard Convection</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/subhk/Tarang.jl/blob/main/docs/src/tutorials/ivp_2d_rbc.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Tutorial:-2D-Rayleigh-Bénard-Convection"><a class="docs-heading-anchor" href="#Tutorial:-2D-Rayleigh-Bénard-Convection">Tutorial: 2D Rayleigh-Bénard Convection</a><a id="Tutorial:-2D-Rayleigh-Bénard-Convection-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial:-2D-Rayleigh-Bénard-Convection" title="Permalink"></a></h1><p>This tutorial demonstrates solving a classic fluid dynamics problem: Rayleigh-Bénard convection. We&#39;ll set up a complete simulation including equations, boundary conditions, adaptive time stepping, and output.</p><h2 id="Physical-Problem"><a class="docs-heading-anchor" href="#Physical-Problem">Physical Problem</a><a id="Physical-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Physical-Problem" title="Permalink"></a></h2><p>Rayleigh-Bénard convection occurs when a fluid layer is heated from below. The setup:</p><ul><li>Horizontal layer of fluid between two parallel plates</li><li>Bottom plate at temperature T_hot</li><li>Top plate at temperature T_cold</li><li>Gravity acts downward</li></ul><p>When the temperature difference is large enough (high Rayleigh number), the fluid becomes unstable and convection cells form.</p><h3 id="Governing-Equations"><a class="docs-heading-anchor" href="#Governing-Equations">Governing Equations</a><a id="Governing-Equations-1"></a><a class="docs-heading-anchor-permalink" href="#Governing-Equations" title="Permalink"></a></h3><p>The Boussinesq equations for thermal convection:</p><p class="math-container">\[\begin{aligned}
\frac{\partial \mathbf{u}}{\partial t} + \mathbf{u} \cdot \nabla \mathbf{u} &amp;= -\nabla p + \text{Pr} \nabla^2 \mathbf{u} + \text{Ra} \cdot \text{Pr} \cdot T \, \hat{\mathbf{z}} \\
\nabla \cdot \mathbf{u} &amp;= 0 \\
\frac{\partial T}{\partial t} + \mathbf{u} \cdot \nabla T &amp;= \nabla^2 T
\end{aligned}\]</p><p><strong>Dimensionless parameters</strong>:</p><ul><li><strong>Ra</strong> (Rayleigh number): <span>$\text{Ra} = \frac{g \alpha \Delta T H^3}{\nu \kappa}$</span> - ratio of buoyancy to viscous forces</li><li><strong>Pr</strong> (Prandtl number): <span>$\text{Pr} = \frac{\nu}{\kappa}$</span> - ratio of momentum to thermal diffusivity</li></ul><p><strong>Variables</strong>:</p><ul><li><p class="math-container">\[\mathbf{u} = (u, w)\]</p>: velocity field (horizontal u, vertical w)</li><li><p class="math-container">\[p\]</p>: pressure</li><li><p class="math-container">\[T\]</p>: temperature (deviation from linear conduction profile)</li></ul><h2 id="Domain-and-Discretization"><a class="docs-heading-anchor" href="#Domain-and-Discretization">Domain and Discretization</a><a id="Domain-and-Discretization-1"></a><a class="docs-heading-anchor-permalink" href="#Domain-and-Discretization" title="Permalink"></a></h2><h3 id="Coordinate-System"><a class="docs-heading-anchor" href="#Coordinate-System">Coordinate System</a><a id="Coordinate-System-1"></a><a class="docs-heading-anchor-permalink" href="#Coordinate-System" title="Permalink"></a></h3><p>2D Cartesian domain:</p><ul><li><strong>x</strong> (horizontal): periodic, length <span>$L_x$</span></li><li><strong>z</strong> (vertical): bounded by plates, height <span>$H = 1$</span></li></ul><h3 id="Spectral-Bases"><a class="docs-heading-anchor" href="#Spectral-Bases">Spectral Bases</a><a id="Spectral-Bases-1"></a><a class="docs-heading-anchor-permalink" href="#Spectral-Bases" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Periodic horizontal direction → Fourier
x_basis = RealFourier(coords[&quot;x&quot;]; size=256, bounds=(0.0, 4.0))

# Bounded vertical direction → Chebyshev
z_basis = ChebyshevT(coords[&quot;z&quot;]; size=64, bounds=(0.0, 1.0))</code></pre><p><strong>Resolution guidelines</strong>:</p><ul><li>Horizontal: 128-512 modes (depends on aspect ratio and Ra)</li><li>Vertical: 32-128 modes (more for higher Ra)</li><li>Aspect ratio <span>$L_x/H$</span>: typically 2-4 for 2D</li></ul><h2 id="Complete-Implementation"><a class="docs-heading-anchor" href="#Complete-Implementation">Complete Implementation</a><a id="Complete-Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Complete-Implementation" title="Permalink"></a></h2><h3 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h3><pre><code class="language-julia hljs">using Tarang
using MPI
using Printf

# Initialize MPI
MPI.Init()
rank = MPI.Comm_rank(MPI.COMM_WORLD)
size = MPI.Comm_size(MPI.COMM_WORLD)

# Problem parameters
Ra = 1e6  # Rayleigh number
Pr = 1.0  # Prandtl number
Lx = 4.0  # Horizontal extent
H = 1.0   # Vertical extent

# Domain setup
coords = CartesianCoordinates(&quot;x&quot;, &quot;z&quot;)
dist = Distributor(coords, mesh=(2, 2))

# Spectral bases
Nx, Nz = 256, 64
x_basis = RealFourier(coords[&quot;x&quot;]; size=Nx, bounds=(0.0, Lx))
z_basis = ChebyshevT(coords[&quot;z&quot;]; size=Nz, bounds=(0.0, H))

domain = Domain(dist, (x_basis, z_basis))</code></pre><h3 id="Fields"><a class="docs-heading-anchor" href="#Fields">Fields</a><a id="Fields-1"></a><a class="docs-heading-anchor-permalink" href="#Fields" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Create velocity field (vector with 2 components)
u = VectorField(dist, coords, &quot;u&quot;, (x_basis, z_basis))
ux = u.components[1]  # Horizontal velocity
uz = u.components[2]  # Vertical velocity

# Pressure field
p = ScalarField(dist, &quot;p&quot;, (x_basis, z_basis))

# Temperature field
T = ScalarField(dist, &quot;T&quot;, (x_basis, z_basis))</code></pre><h3 id="Tau-Fields-(for-Boundary-Conditions)"><a class="docs-heading-anchor" href="#Tau-Fields-(for-Boundary-Conditions)">Tau Fields (for Boundary Conditions)</a><a id="Tau-Fields-(for-Boundary-Conditions)-1"></a><a class="docs-heading-anchor-permalink" href="#Tau-Fields-(for-Boundary-Conditions)" title="Permalink"></a></h3><p>Tarang.jl follows the <a href="https://dedalus-project.readthedocs.io/">Dedalus</a> approach: users must explicitly create tau fields and add them to equations using the <code>lift()</code> operator.</p><pre><code class="language-julia hljs"># Tau field for pressure (removes degeneracy in continuity equation)
tau_p = ScalarField(dist, &quot;tau_p&quot;, (), dtype)

# Tau fields for temperature/buoyancy BCs (one per boundary)
tau_T1 = ScalarField(dist, &quot;tau_T1&quot;, (x_basis,), dtype)   # T at z=0
tau_T2 = ScalarField(dist, &quot;tau_T2&quot;, (x_basis,), dtype)   # T at z=1

# Vector tau fields for velocity BCs (uses VectorField for compact notation)
tau_u1 = VectorField(dist, coords, &quot;tau_u1&quot;, (x_basis,), dtype)  # Velocity at z=0
tau_u2 = VectorField(dist, coords, &quot;tau_u2&quot;, (x_basis,), dtype)  # Velocity at z=1</code></pre><div class="admonition is-success" id="Vector-Tau-Fields-cda3ab0699da820d"><header class="admonition-header">Vector Tau Fields<a class="admonition-anchor" href="#Vector-Tau-Fields-cda3ab0699da820d" title="Permalink"></a></header><div class="admonition-body"><p>Using <code>VectorField</code> for tau fields allows compact vector notation in equations. The components are accessed via <code>tau_u1.components[1]</code> (x) and <code>tau_u1.components[2]</code> (z).</p></div></div><h3 id="Problem-Definition"><a class="docs-heading-anchor" href="#Problem-Definition">Problem Definition</a><a id="Problem-Definition-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Definition" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Collect all state variables (vector fields passed directly)
problem = IVP([u, p, T, tau_u1, tau_u2, tau_p, tau_T1, tau_T2])

# Add substitutions for parameters (Dedalus-style)
add_substitution!(problem, &quot;Ra&quot;, Ra)
add_substitution!(problem, &quot;Pr&quot;, Pr)
add_substitution!(problem, &quot;Lz&quot;, H)

# Equations use vector notation (Dedalus-style)
# Continuity: ∇·u = 0
add_equation!(problem, &quot;div(u) + tau_p = 0&quot;)

# Temperature equation: ∂T/∂t - ∇²T = -u·∇T
add_equation!(problem, &quot;∂t(T) - Δ(T) + lift(tau_T2) = -u⋅∇(T)&quot;)

# Momentum (vector equation): ∂u/∂t - Pr∇²u + ∇p = -u·∇u + Ra*Pr*T*ez
# ez is the unit vector in z-direction (buoyancy acts vertically)
add_equation!(problem, &quot;∂t(u) - Pr*Δ(u) + ∇(p) + lift(tau_u2) = -u⋅∇(u) + Ra*Pr*T*ez&quot;)</code></pre><h3 id="Boundary-Conditions"><a class="docs-heading-anchor" href="#Boundary-Conditions">Boundary Conditions</a><a id="Boundary-Conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Boundary-Conditions" title="Permalink"></a></h3><p>No-slip walls (velocity = 0) and fixed temperatures, using Dedalus-style string format:</p><pre><code class="language-julia hljs"># Temperature BCs
add_bc!(problem, &quot;T(z=0) = 1&quot;)      # Hot bottom
add_bc!(problem, &quot;T(z=Lz) = 0&quot;)     # Cold top

# Velocity BCs (no-slip at both walls) - vector notation
add_bc!(problem, &quot;u(z=0) = 0&quot;)      # No-slip bottom (sets all components)
add_bc!(problem, &quot;u(z=Lz) = 0&quot;)     # No-slip top</code></pre><div class="admonition is-info" id="Equation-String-Syntax-3564394f80481858"><header class="admonition-header">Equation String Syntax<a class="admonition-anchor" href="#Equation-String-Syntax-3564394f80481858" title="Permalink"></a></header><div class="admonition-body"><p>Tarang.jl uses Dedalus-style string equations:</p><ul><li>Unicode operators: <code>∂t</code> (time derivative), <code>Δ</code> (Laplacian), <code>∇</code> (gradient)</li><li>Vector advection: <code>u⋅∇(u)</code> for nonlinear term</li><li>Scalar advection: <code>u⋅∇(T)</code> for temperature advection</li><li>Unit vectors: <code>ex</code>, <code>ey</code>, <code>ez</code> for directions (e.g., <code>Ra*Pr*T*ez</code> for buoyancy)</li><li>Vector BCs: <code>u(z=0) = 0</code> sets all velocity components at the boundary</li></ul></div></div><h3 id="Initial-Conditions"><a class="docs-heading-anchor" href="#Initial-Conditions">Initial Conditions</a><a id="Initial-Conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Initial-Conditions" title="Permalink"></a></h3><p>Add random perturbations to trigger convection:</p><pre><code class="language-julia hljs"># Get grid-space data
T_grid = get_grid_data(T)

# Add small random perturbations
Random.seed!(42 + rank)  # Different seed per rank
T_grid .= 0.5 .+ 0.01 .* (rand(size(T_grid)...) .- 0.5)

# Transform to spectral space
to_spectral!(T)

# Velocity starts at zero (already initialized)</code></pre><h3 id="Time-Stepper-and-Solver"><a class="docs-heading-anchor" href="#Time-Stepper-and-Solver">Time Stepper and Solver</a><a id="Time-Stepper-and-Solver-1"></a><a class="docs-heading-anchor-permalink" href="#Time-Stepper-and-Solver" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Choose timestepper
# RK222: Good for moderate Ra
# CNAB2 or SBDF2: Better for high Ra (more stable for stiff problems)
timestepper = RK222()

# Create solver
solver = InitialValueSolver(problem, timestepper, dt=1e-4)</code></pre><p><strong>Timestepper selection</strong>:</p><ul><li>Ra &lt; 10⁵: RK222 or RK443 (IMEX Runge-Kutta)</li><li>Ra &gt; 10⁵: CNAB2 or SBDF2 (IMEX multistep)</li><li>Very high Ra: SBDF3 or SBDF4</li></ul><h3 id="Adaptive-Time-Stepping-(CFL)"><a class="docs-heading-anchor" href="#Adaptive-Time-Stepping-(CFL)">Adaptive Time Stepping (CFL)</a><a id="Adaptive-Time-Stepping-(CFL)-1"></a><a class="docs-heading-anchor-permalink" href="#Adaptive-Time-Stepping-(CFL)" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Create CFL condition
cfl = CFL(problem, safety=0.4, max_change=1.5, min_change=0.5)

# Add velocity field for CFL calculation
add_velocity!(cfl, u)

# Set maximum timestep
cfl.max_dt = 0.01</code></pre><p><strong>CFL parameters</strong>:</p><ul><li><code>safety</code>: Safety factor (0.2-0.5, lower = more stable)</li><li><code>max_change</code>: Maximum timestep increase per step</li><li><code>min_change</code>: Maximum timestep decrease per step</li></ul><h3 id="Output-and-Analysis"><a class="docs-heading-anchor" href="#Output-and-Analysis">Output and Analysis</a><a id="Output-and-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Output-and-Analysis" title="Permalink"></a></h3><pre><code class="language-julia hljs"># File output handler
output_handler = add_netcdf_handler(
    solver,
    &quot;rayleigh_benard_output&quot;,
    fields=[ux, uz, p, T],
    write_interval=0.1  # Write every 0.1 time units
)

# Analysis: Compute Nusselt number (heat flux)
function compute_nusselt(T, uz)
    # Nu = 1 + &lt;uz*T&gt; (horizontally averaged)
    T_grid = get_grid_data(T)
    uz_grid = get_grid_data(uz)

    flux = mean(uz_grid .* T_grid, dims=1)  # Average over x
    Nu = 1.0 .+ flux

    return mean(Nu)  # Average over z as well
end</code></pre><h3 id="Time-Stepping-Loop"><a class="docs-heading-anchor" href="#Time-Stepping-Loop">Time-Stepping Loop</a><a id="Time-Stepping-Loop-1"></a><a class="docs-heading-anchor-permalink" href="#Time-Stepping-Loop" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Simulation parameters
t_end = 10.0
output_dt = 0.1
next_output = output_dt

# Diagnostics
iteration = 0
start_time = time()

if rank == 0
    println(&quot;Starting Rayleigh-Bénard simulation&quot;)
    println(&quot;Ra = $Ra, Pr = $Pr&quot;)
    println(&quot;Resolution: $Nx × $Nz&quot;)
    println(&quot;MPI processes: $size&quot;)
    println(&quot;=&quot; ^ 60)
end

# Main time loop
while solver.sim_time &lt; t_end
    # Compute adaptive timestep
    dt = compute_timestep(cfl)

    # Take a step
    step!(solver, dt)

    iteration += 1

    # Output and diagnostics
    if solver.sim_time &gt;= next_output
        # Compute Nusselt number
        Nu = compute_nusselt(T, uz)

        if rank == 0
            elapsed = time() - start_time
            @printf(&quot;t = %.3f, dt = %.2e, Nu = %.3f, wall_time = %.1fs\n&quot;,
                    solver.sim_time, dt, Nu, elapsed)
        end

        next_output += output_dt
    end
end

if rank == 0
    total_time = time() - start_time
    @printf(&quot;\nSimulation complete!\n&quot;)
    @printf(&quot;Total iterations: %d\n&quot;, iteration)
    @printf(&quot;Total wall time: %.2f s\n&quot;, total_time)
    @printf(&quot;Time per iteration: %.3f ms\n&quot;, 1000 * total_time / iteration)
end

# Cleanup
MPI.Finalize()</code></pre><h2 id="Running-the-Simulation"><a class="docs-heading-anchor" href="#Running-the-Simulation">Running the Simulation</a><a id="Running-the-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-Simulation" title="Permalink"></a></h2><p>Save the complete script as <code>rayleigh_benard_2d.jl</code> and run:</p><pre><code class="language-bash hljs"># Set threads
export OMP_NUM_THREADS=1

# Run with 4 MPI processes
mpiexec -n 4 julia --project rayleigh_benard_2d.jl</code></pre><p><strong>Expected output</strong>:</p><pre><code class="nohighlight hljs">Starting Rayleigh-Bénard simulation
Ra = 1000000.0, Pr = 1.0
Resolution: 256 × 64
MPI processes: 4
============================================================
t = 0.100, dt = 2.45e-04, Nu = 1.023, wall_time = 3.2s
t = 0.200, dt = 2.31e-04, Nu = 1.156, wall_time = 6.5s
...</code></pre><h2 id="Physical-Interpretation"><a class="docs-heading-anchor" href="#Physical-Interpretation">Physical Interpretation</a><a id="Physical-Interpretation-1"></a><a class="docs-heading-anchor-permalink" href="#Physical-Interpretation" title="Permalink"></a></h2><h3 id="Flow-Regimes"><a class="docs-heading-anchor" href="#Flow-Regimes">Flow Regimes</a><a id="Flow-Regimes-1"></a><a class="docs-heading-anchor-permalink" href="#Flow-Regimes" title="Permalink"></a></h3><p>Different Rayleigh numbers produce different behaviors:</p><table><tr><th style="text-align: right">Ra</th><th style="text-align: right">Regime</th><th style="text-align: right">Characteristics</th></tr><tr><td style="text-align: right">&lt; 1708</td><td style="text-align: right">Conduction</td><td style="text-align: right">No flow, pure diffusion</td></tr><tr><td style="text-align: right">10³-10⁴</td><td style="text-align: right">Steady rolls</td><td style="text-align: right">Regular convection cells</td></tr><tr><td style="text-align: right">10⁵-10⁶</td><td style="text-align: right">Transitional</td><td style="text-align: right">Time-dependent, irregular</td></tr><tr><td style="text-align: right">&gt; 10⁶</td><td style="text-align: right">Turbulent</td><td style="text-align: right">Chaotic, small-scale structures</td></tr></table><h3 id="Nusselt-Number"><a class="docs-heading-anchor" href="#Nusselt-Number">Nusselt Number</a><a id="Nusselt-Number-1"></a><a class="docs-heading-anchor-permalink" href="#Nusselt-Number" title="Permalink"></a></h3><p>The Nusselt number measures heat transfer enhancement:</p><p class="math-container">\[\text{Nu} = \frac{\text{Total heat flux}}{\text{Conductive heat flux}}\]</p><ul><li>Nu = 1: Pure conduction (no convection)</li><li>Nu &gt; 1: Enhanced heat transfer due to convection</li><li>Higher Ra → Higher Nu</li></ul><p>For Rayleigh-Bénard convection:</p><ul><li>Nu ≈ 1.0 for Ra &lt; 1708</li><li>Nu ∝ Ra^(1/3) approximately for turbulent regime</li></ul><h2 id="Visualization"><a class="docs-heading-anchor" href="#Visualization">Visualization</a><a id="Visualization-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization" title="Permalink"></a></h2><h3 id="Basic-Plotting"><a class="docs-heading-anchor" href="#Basic-Plotting">Basic Plotting</a><a id="Basic-Plotting-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Plotting" title="Permalink"></a></h3><pre><code class="language-julia hljs">using Plots

# Extract data from one field
T_grid = get_grid_data(T)

# Plot temperature field
heatmap(T_grid&#39;, xlabel=&quot;x&quot;, ylabel=&quot;z&quot;, title=&quot;Temperature&quot;)
savefig(&quot;temperature.png&quot;)</code></pre><h3 id="Advanced-Analysis"><a class="docs-heading-anchor" href="#Advanced-Analysis">Advanced Analysis</a><a id="Advanced-Analysis-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Analysis" title="Permalink"></a></h3><pre><code class="language-julia hljs"># Compute kinetic energy spectrum
function compute_spectrum(u)
    u_spectral = get_spectral_data(u)
    energy = abs2.(u_spectral)

    # Bin by wavenumber magnitude
    # ... (see Analysis tutorial for details)

    return k, E_k
end

k, E_k = compute_spectrum(ux)
plot(k, E_k, xscale=:log10, yscale=:log10,
     xlabel=&quot;k&quot;, ylabel=&quot;E(k)&quot;, label=&quot;Kinetic Energy&quot;)</code></pre><h2 id="Parameter-Studies"><a class="docs-heading-anchor" href="#Parameter-Studies">Parameter Studies</a><a id="Parameter-Studies-1"></a><a class="docs-heading-anchor-permalink" href="#Parameter-Studies" title="Permalink"></a></h2><h3 id="Exploring-Rayleigh-Number"><a class="docs-heading-anchor" href="#Exploring-Rayleigh-Number">Exploring Rayleigh Number</a><a id="Exploring-Rayleigh-Number-1"></a><a class="docs-heading-anchor-permalink" href="#Exploring-Rayleigh-Number" title="Permalink"></a></h3><p>Study the transition to turbulence:</p><pre><code class="language-julia hljs">Ra_values = [1e4, 1e5, 1e6, 1e7]

for Ra in Ra_values
    problem.parameters[&quot;Ra&quot;] = Ra
    # ... run simulation and save Nu
end</code></pre><h3 id="Aspect-Ratio-Effects"><a class="docs-heading-anchor" href="#Aspect-Ratio-Effects">Aspect Ratio Effects</a><a id="Aspect-Ratio-Effects-1"></a><a class="docs-heading-anchor-permalink" href="#Aspect-Ratio-Effects" title="Permalink"></a></h3><p>Try different domain sizes:</p><pre><code class="language-julia hljs">aspect_ratios = [1.0, 2.0, 4.0, 8.0]

for ar in aspect_ratios
    Lx = ar * H
    x_basis = RealFourier(coords[&quot;x&quot;]; size=Int(128*ar), bounds=(0.0, Lx))
    # ... run simulation
end</code></pre><h2 id="Performance-Optimization"><a class="docs-heading-anchor" href="#Performance-Optimization">Performance Optimization</a><a id="Performance-Optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Optimization" title="Permalink"></a></h2><h3 id="Resolution-Requirements"><a class="docs-heading-anchor" href="#Resolution-Requirements">Resolution Requirements</a><a id="Resolution-Requirements-1"></a><a class="docs-heading-anchor-permalink" href="#Resolution-Requirements" title="Permalink"></a></h3><p>For Ra = 10⁶:</p><ul><li>Minimum: 128 × 32</li><li>Recommended: 256 × 64</li><li>High-resolution: 512 × 128</li></ul><p><strong>Scaling</strong>: For Ra × 10, increase resolution by ~1.5×</p><h3 id="MPI-Process-Mesh"><a class="docs-heading-anchor" href="#MPI-Process-Mesh">MPI Process Mesh</a><a id="MPI-Process-Mesh-1"></a><a class="docs-heading-anchor-permalink" href="#MPI-Process-Mesh" title="Permalink"></a></h3><table><tr><th style="text-align: right">Processes</th><th style="text-align: right">Recommended Mesh</th><th style="text-align: right">Domain</th></tr><tr><td style="text-align: right">4</td><td style="text-align: right">(2, 2)</td><td style="text-align: right">Square/moderate aspect</td></tr><tr><td style="text-align: right">8</td><td style="text-align: right">(4, 2) or (2, 4)</td><td style="text-align: right">Match domain aspect ratio</td></tr><tr><td style="text-align: right">16</td><td style="text-align: right">(4, 4)</td><td style="text-align: right">Square mesh works well</td></tr></table><h3 id="Timestep-Control"><a class="docs-heading-anchor" href="#Timestep-Control">Timestep Control</a><a id="Timestep-Control-1"></a><a class="docs-heading-anchor-permalink" href="#Timestep-Control" title="Permalink"></a></h3><pre><code class="language-julia hljs"># For stability at high Ra
cfl.safety = 0.3  # Reduce if getting NaN

# For efficiency
cfl.max_dt = 0.01  # Don&#39;t let dt grow too large
cfl.max_change = 1.2  # Smooth timestep changes</code></pre><h2 id="Troubleshooting"><a class="docs-heading-anchor" href="#Troubleshooting">Troubleshooting</a><a id="Troubleshooting-1"></a><a class="docs-heading-anchor-permalink" href="#Troubleshooting" title="Permalink"></a></h2><h3 id="NaN-in-Solution"><a class="docs-heading-anchor" href="#NaN-in-Solution">NaN in Solution</a><a id="NaN-in-Solution-1"></a><a class="docs-heading-anchor-permalink" href="#NaN-in-Solution" title="Permalink"></a></h3><p><strong>Causes</strong>:</p><ul><li>Timestep too large</li><li>Ra too high for resolution</li><li>Insufficient damping</li></ul><p><strong>Solutions</strong>:</p><pre><code class="language-julia hljs"># Reduce CFL safety factor
cfl.safety = 0.2

# Use more stable timestepper
timestepper = CNAB2()  # instead of RK222

# Increase resolution
Nz = 128  # instead of 64</code></pre><h3 id="Simulation-Not-Converging"><a class="docs-heading-anchor" href="#Simulation-Not-Converging">Simulation Not Converging</a><a id="Simulation-Not-Converging-1"></a><a class="docs-heading-anchor-permalink" href="#Simulation-Not-Converging" title="Permalink"></a></h3><p><strong>For steady state</strong>:</p><ul><li>Run longer (convection takes time to develop)</li><li>Check initial conditions have perturbations</li><li>Verify Ra &gt; 1708 (critical value)</li></ul><h3 id="Memory-Issues"><a class="docs-heading-anchor" href="#Memory-Issues">Memory Issues</a><a id="Memory-Issues-1"></a><a class="docs-heading-anchor-permalink" href="#Memory-Issues" title="Permalink"></a></h3><p><strong>Solutions</strong>:</p><pre><code class="language-julia hljs"># Reduce resolution
Nx, Nz = 128, 32

# Use more MPI processes
mesh=(4, 4)  # instead of (2, 2)</code></pre><h2 id="Complete-Script"><a class="docs-heading-anchor" href="#Complete-Script">Complete Script</a><a id="Complete-Script-1"></a><a class="docs-heading-anchor-permalink" href="#Complete-Script" title="Permalink"></a></h2><p>The full script is available in <code>examples/rayleigh_benard_2d.jl</code>. Key points:</p><ol><li>Proper MPI initialization and finalization</li><li>Appropriate bases for boundary conditions</li><li>Explicit tau fields for each boundary condition</li><li>lift() operators in all equations with non-periodic BCs</li><li>Complete equation system with nonlinear terms</li><li>All boundary conditions linked to tau fields</li><li>Adaptive time stepping with CFL</li><li>Output and analysis</li><li>Performance monitoring</li></ol><div class="admonition is-info" id="Dedalus-Style-Approach-d32dda610610577"><header class="admonition-header">Dedalus-Style Approach<a class="admonition-anchor" href="#Dedalus-Style-Approach-d32dda610610577" title="Permalink"></a></header><div class="admonition-body"><p>This tutorial follows the Dedalus approach for boundary conditions. Users must explicitly:</p><ul><li>Create tau fields (one per BC)</li><li>Add tau fields to the problem</li><li>Include lift() terms in equations</li><li>Link each BC to its tau field</li></ul><p>See <a href="../boundary_conditions/">Boundary Conditions Tutorial</a> for more details.</p></div></div><h2 id="Next-Steps"><a class="docs-heading-anchor" href="#Next-Steps">Next Steps</a><a id="Next-Steps-1"></a><a class="docs-heading-anchor-permalink" href="#Next-Steps" title="Permalink"></a></h2><ul><li><strong><a href="../ivp_3d_turbulence/">3D Extension</a></strong>: Add third dimension</li><li><strong><a href="../eigenvalue_problems/">Eigenvalue Analysis</a></strong>: Compute stability</li><li><strong><a href="../analysis_and_output/">Custom Analysis</a></strong>: Advanced diagnostics</li></ul><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><ol><li>Chandrasekhar, S. (1961). <em>Hydrodynamic and Hydromagnetic Stability</em></li><li>Tritton, D. J. (1988). <em>Physical Fluid Dynamics</em></li><li>Spectral Methods Resources</li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../overview/">« Tutorials Overview</a><a class="docs-footer-nextpage" href="../ivp_3d_turbulence/">Tutorial: 3D Turbulence Simulation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and <a href="https://julialang.org">Julia</a>. Tarang.jl © 2024 Subhajit Kar.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Sunday 18 January 2026 08:49">Sunday 18 January 2026</span>. Using Julia version 1.12.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
